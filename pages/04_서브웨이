import streamlit as st
import pandas as pd
import plotly.express as px

st.title("ğŸ“Š ì—­ë³„ ìŠ¹ê°ìˆ˜ ë¶„ì„")

@st.cache_data
def load_data():
    df = pd.read_csv("data/ì„œë¸Œì›¨ì´.csv", encoding="cp949")
    df["ì´ìŠ¹ê°ìˆ˜"] = df["ìŠ¹ì°¨ì´ìŠ¹ê°ìˆ˜"] + df["í•˜ì°¨ì´ìŠ¹ê°ìˆ˜"]
    df["ì‚¬ìš©ì¼ì"] = df["ì‚¬ìš©ì¼ì"].astype(str)
    df["date"] = pd.to_datetime(df["ì‚¬ìš©ì¼ì"], format="%Y%m%d", errors="coerce")
    return df

df = load_data()

# -----------------------------
# 1) ë‚ ì§œ ì„ íƒ (2025ë…„ 10ì›”ë§Œ í•„í„°ë§)
# -----------------------------
oct_2025 = df[df["date"].dt.strftime("%Y-%m").eq("2025-10")]
unique_days = sorted(oct_2025["date"].dt.date.unique())

selected_day = st.selectbox("ğŸ“… ë‚ ì§œ ì„ íƒ (2025ë…„ 10ì›”)", unique_days)

# -----------------------------
# 2) í˜¸ì„  ì„ íƒ
# -----------------------------
selected_day_df = oct_2025[oct_2025["date"].dt.date == selected_day]
lines = sorted(selected_day_df["ë…¸ì„ ëª…"].unique())

selected_line = st.selectbox("ğŸšˆ í˜¸ì„  ì„ íƒ", lines)

# -----------------------------
# 3) í˜¸ì„  + ë‚ ì§œ í•„í„°ë§ í›„ ì—­ë³„ ìŠ¹ê°ìˆ˜ ì§‘ê³„
# -----------------------------
filtered = selected_day_df[selected_day_df["ë…¸ì„ ëª…"] == selected_line]

rank_df = (
    filtered.groupby("ì—­ëª…")["ì´ìŠ¹ê°ìˆ˜"]
    .sum()
    .sort_values(ascending=False)
    .reset_index()
)

# -----------------------------
# 4) ìƒ‰ìƒ ì„¤ì • (1ë“± ë¹¨ê°• + íŒŒë€ìƒ‰ ê·¸ë¼ë°ì´ì…˜)
# -----------------------------
base_blue = [0, 100, 255]

colors = []
for i in range(len(rank_df)):
    if i == 0:
        colors.append("red")
    else:
        fade_factor = 0.7 + (i / len(rank_df)) * 0.3
        blue = f"rgba({base_blue[0]}, {base_blue[1]}, {base_blue[2]}, {fade_factor})"
        colors.append(blue)

rank_df["color"] = colors

# -----------------------------
# 5) Plotly ê·¸ë˜í”„ ìƒì„±
# -----------------------------
fig = px.bar(
    rank_df,
    x="ì—­ëª…",
    y="ì´ìŠ¹ê°ìˆ˜",
    title=f"{selected_day} Â· {selected_line} ìŠ¹í•˜ì°¨ í•©ê³„ TOP ì—­",
)

fig.update_traces(marker_color=rank_df["color"])
fig.update_layout(xaxis_title="ì—­ëª…", yaxis_title="ìŠ¹ê°ìˆ˜", template="plotly_white")

st.plotly_chart(fig, use_container_width=True)

st.write("### ğŸ“„ ë°ì´í„° í…Œì´ë¸”")
st.dataframe(rank_df)
